---
title: "Agent based simulation of a Perpetual Futures Market"
author: "Ramshreyas Rao"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(somebm)
library(scatterplot3d)
library(ggfortify)
library(orderbook)

source("agent.R", local = knitr::knit_global())
source("forecast.R", local = knitr::knit_global())
source("orderbook.R", local = knitr::knit_global())

# # Create GBM with the following values
# tMax <- 2000
# spot_price <- gbm(x0=100, mu=1, sigma=0.5, t0=0, t=1, n=tMax)
# 
# # Set number of agents
# nAgents <- 200
# 
# # Fundamentalist weight
# sigmaF <- 0
# 
# # Chartist weight
# sigmaC <- 10
# 
# # Noise weight
# sigmaN <- 1
# 
# # random component of spread
# kMax <- 0.5
# 
# # horizons for momentum rules - bounds for how far back should they go to estimate trend
# lMin <- 5
# lMax <- 50
# 
# # Initialize traders list
# traders <- data.frame(matrix(ncol = 6, nrow = 0))
# names(traders) <- c("Fundamentalist", "Chartist", "Noise", "Horizon", "Spread", "Side")
# 
# # Create traders
# for (i in 1:nAgents) {
#   traders[i,] <- createAgentVector(sigmaF, sigmaC, sigmaN, kMax, lMin, lMax)
# }
# 
# perp_prices <- spot_price + runif(tMax+1, -1, 1)
# 
# premia <- perp_prices - spot_price
# 
# bias <- 0.5
# 
# close_position_probability <- 0.05
# 
# sigmaE <- 0.05
# 
# t <- 250
# 
# tau <- 4
# 
# cohortSize <- 4
# 
# ob <- orderbook("orderbook.txt")
# 
# for(i in (t - 2*tau):(t-1)) {
#   if(i %% 2 == 0) {
#     ob <- add.order(ob, spot_price[i] - sample(0:10, 1), 1, type = "BID", time = t, id = i)
#   } else {
#     ob <- add.order(ob, spot_price[i] + sample(0:10, 1), 1, type = "ASK", time = t, id = i)
#   }
# }
# 
# for (t in 250:tMax) {
#   # Select random traders
#   cohort <- traders[sample(1:nAgents, cohortSize), ]
# 
#   newPrice <- NULL
# 
#   # Iteratively make bids and asks on the same price point, exit if trade occurs
#   for (row in 1:cohortSize) {
#     # Get trader
#     trader <- cohort[row, ]
# 
#     # Get order
#     order <- getOrder(trader, premia, spot_price, t = t, bias, close_position_probability, sigmaE = sigmaE)
#     price <- order[[2]]
#     size <- order[[3]]
# 
#     if(price == 0) next
# 
#     # Add to book as market or limit
#     result <- addOrder(ob, order, t)
#     ob <- result[[1]]
#     newPrice <- result[[2]]
# 
#     # Check if trade occurs
#     if (!is.null(newPrice)) {
#       break()
#     }
#   }
# 
#   # If no trade occurred, set price to mid point
#   if (is.null(newPrice)) {
#     # Update perp price as midpoint between best ask and best bid
#     newPrice <- mid.point(ob)
#   }
# 
#   if(is.na(newPrice)) {
#     newPrice <- spot_price[t] + runif(1)
#   }
# 
#   # Update perp_prices
#   perp_prices[t+1] <- newPrice
# 
#   # Update premia
#   premia[t+1] <- perp_prices[t+1] - spot_price[t+1]
# 
#   # Clean old trades
#   ob <- removeOldOrders(ob, tau, t)
# }

```

## Simulations and Results

---

We first consider a spot market whose prices are represented by a Geometric Brownian Motion:

$\Delta S_t = \mu \Delta t + \sigma \epsilon \sqrt{\Delta t}$ 

Here $S_t$ is the stock price at timestep $t$, $\mu$ is a constant 'drift' parameter, and $\sigma$ is a constant volatility parameter. $\Delta S_t$ is the increment or decrement applied to the current spot price at time $t$ to generate the spot price at $t+1$. 

Next, we consider a perp market derived from this spot market, with 200 traders. At any time $t$, the entire history of both the spot market and perp market prices for the time interval $(1,2...t)$ are visible to the traders in the perp market. 

The $Premium$ at any time $t$ is defined as:

$Premium_t = Perp\ price_t - Spot\ price_t$

```{r, echo=FALSE,out.width="49%", out.height="20%",fig.show='hold',fig.align='left', fig.cap="Figure 1: Results of a simulation run with $\\mu = 1$, $\\sigma = 0.5$ and $S_0 = 100$. On the left we see the Spot Prices vs the Perp Prices. The 'peg' is clearly holding, with the Perp prices in green tracking the spot prices in red. On the right we see a chart of the premium, the difference between the Perp and Spot prices."}
knitr::include_graphics(c("Figures/Spot_Perps1.png","Figures/Premia1.png"))
``` 

---

### Simulation Parameters

The behavior of the traders is entirely determined by these two price signals, and the following parameters:

#### Forecasting Parameters:

$\sigma_f$: The weightage given by a trader to fundamentalist strategies. This is set to $0$ as discussed in the methods section above.

$\sigma_c$: The weightage given by a trader to chartist strategies

$\sigma_n$: The weightage given by a trader to noise strategies

$\sigma_\epsilon$: A volatility parameter used by the noise strategy to produce forecasts

$l_{min}, l_{max}$: The time horizon used by the Chartist strategy to generate forecasts

#### Trading parameters:

$k_{max}$: The range above and below the forecast price from which the trader selects their Bid and Ask prices

$bias$: Modulates the tendency for a trader to prefer positional or basis trading startegies based on whether they are trading long or short.

$exit_{probability}$: The probability of exiting the market at each timestep

$\tau$: all Bids and Asks more than $\tau$ before the latest Bid or Ask are expired

$cohort_{size}$: The number of randomly drawn traders who participate in trading at each timestep

---

### Simulations

We start by analyzing the effect of varying the strategy-weighting parameters on the 'peg' of the perp price to the spot price. As discussed in the methods section, the fundamental strategy has zero weight, because it has no meaning in the Perpetual Futures context. This leaves the relative weightage of chartist and noise traders. By keeping the noise parameter constant at $10$ and varying the chartist trader from $1$ to $20$, we can see a range of regimes where the chartist is $\frac{1}{10}$ of the noise trader to the noise trader being $\frac{1}{10}$ of the chartist.

```{r message=FALSE, warning=FALSE}


```



