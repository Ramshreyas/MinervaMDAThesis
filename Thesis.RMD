---
title: "Agent based simulation of a Perpetual Futures Market"
author: "Ramshreyas Rao"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(somebm)
library(scatterplot3d)
library(ggfortify)
library(orderbook)

source("agent.R", local = knitr::knit_global())
source("forecast.R", local = knitr::knit_global())
source("orderbook.R", local = knitr::knit_global())
```

## Spot market price signal

```{r message=FALSE, warning=FALSE}
# Create GBM with the following values
spot_price <- gbm(x0=100, mu=1, sigma=1, t0=0, t=1, n=1000)

# Plot GBM
autoplot(spot_price)
```

## Create distribution of Traders

```{r message=FALSE, warning=FALSE}
# Set number of agents
nAgents <- 100

# Fundamentalist weight
sigmaF <- 1

# Chartist weight
sigmaC <- 10

# Noise weight
sigmaN <- 1

# random component of spread
kMax <- 0.5

# horizons for momentum rules - bounds for how far back should they go to estimate trend
lMin <- 5
lMax <- 50

# Initialize traders list
traders <- data.frame(matrix(ncol = 6, nrow = 0))
names(traders) <- c("Fundamentalist", "Chartist", "Noise", "Horizon", "Spread", "Side")

# Create traders
for (i in 1:nAgents) {
  traders[i,] <- createAgentVector(sigmaF, sigmaC, sigmaN, kMax, lMin, lMax)
}

with(data = traders,
     scatterplot3d(x = Fundamentalist,
                   y = Chartist,
                   z = Noise))
```

## Test forecast and order generation

```{r message=FALSE, warning=FALSE}
perp_prices <- spot_price + runif(1001, -1, 1)

premia <- perp_prices - spot_price

bias <- 0.5

close_position_probability <- 0.2

sigmaE <- 0.05

t <- 250

nSims <- 260

ob <- orderbook("orderbook.txt")

# Pre-populate some bids and asks around the spot price
for(i in 1:5) {
  ob <- add.order(ob, spot_price[t-1] - sample(0:10, 1), 1, type = "BID", time = t)
  ob <- add.order(ob, spot_price[t-1] + sample(0:10, 1), 1, type = "ASK", time = t) 
}

for (t in 250:nSims) {
  # Select random trader
  trader <- traders[sample(1:nAgents, 1), ]

  # Get order
  order <- getOrder(trader, premia, perp_prices, t = t, bias, close_position_probability, sigmaE = sigmaE)
  price <- order[[2]]
  size <- order[[3]]

  # Add to book as market or limit
  result <- addOrder(ob, order, t)
  ob <- result[[1]]
  tradePrice <- result[[2]]["price"]
  
  # Get best Ask and Bid, handle NA
  best_ask <- best.ask(ob)[["price"]]
  if(is.na(best_ask)) { best_ask <- 0 }
  best_bid <- best.bid(ob)[["price"]]
  if(is.na(best_bid)) { best_bid <- 0 }

  # Check if trade occurs
  if (is.null(tradePrice)) {
    # Update perp price as midpoint between best ask and best bid
    tradePrice <- (best_bid + best_ask)/2
    perp_prices[t+1] <- tradePrice

  } else {
    # Update perp_price as trade price
    perp_prices[t+1] <- tradePrice

  }

  # Update premia
  premia[t+1] <- perp_prices[t+1] - spot_price[t+1]

  # Clean old trades
}

plot(spot_price[250:nSims])
plot(perp_prices[250:nSims])
# premia[250:nSims]
show(ob)
```



